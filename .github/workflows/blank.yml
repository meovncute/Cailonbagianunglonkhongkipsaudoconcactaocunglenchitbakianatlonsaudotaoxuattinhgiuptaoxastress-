name: con ng∆∞·ªùi ti·∫øn hpaa

on:
  workflow_dispatch:

env:
  WEBHOOK_URL: https://discord.com/api/webhooks/1327906472029458495/1bSkWLlV_cdvWThG0xK3YNAP7MYTgmyKZB_oK_zIiiw0b7D3u3rsMDUHrYuXiNdeMftq

jobs:
  cloudphone:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: C√†i ph·∫ßn m·ªÅm
        run: |
          sudo apt update -y
          sudo apt install -y qemu-kvm curl wget git

      - name: T·∫£i ISO v√† t·∫°o ƒëƒ©a
        run: |
          wget -O android.iso "https://downloads.sourceforge.net/project/android-x86/Release%209.0/android-x86_64-9.0-r2.iso"
          wget -O driver.iso "https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/archive-virtio/virtio-win-0.1.240.iso"
          sudo qemu-img create -f qcow2 android.qcow2 64G

      - name: C√†i noVNC
        run: |
          git clone https://github.com/novnc/noVNC.git
          cd noVNC
          git submodule update --init --recursive
          nohup ./utils/novnc_proxy --vnc localhost:5900 --listen 6080 &

      - name: T·∫°o file phone.html (SNIPAVNCloud)
        run: |
          cd noVNC
          cat <<'EOF' > phone.html
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8" />
            <title>SNIPAVNCloud</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                background: #000;
                font-family: sans-serif;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
              }
              .controls {
                margin-bottom: 12px;
                display: flex;
                gap: 10px;
              }
              .btn {
                padding: 8px 16px;
                background: #222;
                color: #fff;
                border: none;
                border-radius: 8px;
                cursor: pointer;
                font-size: 14px;
              }
              .phone-frame {
                width: 400px;
                height: 800px;
                background: #111;
                border: 16px solid #333;
                border-radius: 50px;
                box-shadow: 0 0 40px rgba(0, 0, 0, 0.8);
                overflow: hidden;
                position: relative;
                transition: all 0.4s ease;
              }
              .landscape {
                width: 800px;
                height: 400px;
              }
              iframe {
                width: 100%;
                height: 100%;
                border: none;
                background: #000;
              }
              .bottom-bar {
                position: absolute;
                bottom: 10px;
                left: 50%;
                transform: translateX(-50%);
                display: flex;
                justify-content: space-around;
                width: 60%;
              }
              .nav-button {
                width: 45px;
                height: 45px;
                border-radius: 50%;
                background: #444;
                display: flex;
                align-items: center;
                justify-content: center;
                color: white;
                font-size: 18px;
                cursor: pointer;
                user-select: none;
              }
              .clipboard {
                display: flex;
                flex-direction: column;
                gap: 5px;
                margin-top: 15px;
                width: 90%;
                max-width: 400px;
              }
              .clipboard input {
                padding: 8px;
                width: 100%;
                border-radius: 8px;
                border: none;
              }
              .clipboard button {
                padding: 6px;
                border: none;
                border-radius: 6px;
                background: #444;
                color: white;
                cursor: pointer;
              }
            </style>
          </head>
          <body>
            <div class="controls">
              <button class="btn" onclick="toggleRotate()">üîÅ Xoay</button>
              <button class="btn" onclick="setResolution()">üñ•Ô∏è ƒê·ªô ph√¢n gi·∫£i</button>
            </div>
            <div class="phone-frame" id="phone">
              <iframe id="vnc" src="vnc.html?autoconnect=true&resize=scale&clipboard=true&path=websockify"></iframe>
              <div class="bottom-bar">
                <div class="nav-button" onclick="sendKey('Escape')">‚Üê</div>
                <div class="nav-button" onclick="sendKey('Super_L')">‚åÇ</div>
                <div class="nav-button" onclick="sendKey('Menu')">‚ò∞</div>
              </div>
            </div>
            <div class="clipboard">
              <input id="clipText" placeholder="Nh·∫≠p text ƒë·ªÉ g·ª≠i v√†o VPS">
              <button onclick="sendClipboard()">üìã G·ª≠i clipboard</button>
            </div>
            <script>
              function toggleRotate() {
                const phone = document.getElementById('phone');
                phone.classList.toggle('landscape');
              }
              function sendClipboard() {
                const text = document.getElementById('clipText').value;
                const client = window.rfb;
                if (client && client.clipboardPasteFrom) {
                  client.clipboardPasteFrom(text);
                  alert("ƒê√£ g·ª≠i clipboard!");
                } else {
                  alert("Kh√¥ng t√¨m th·∫•y VNC client.");
                }
              }
              function sendKey(key) {
                const event = new KeyboardEvent('keydown', { key });
                const iframe = document.getElementById('vnc').contentWindow;
                iframe.document.dispatchEvent(event);
              }
              function setResolution() {
                const w = prompt("Chi·ªÅu r·ªông (px)", "800");
                const h = prompt("Chi·ªÅu cao (px)", "600");
                const iframe = document.getElementById('vnc');
                iframe.src = `vnc.html?autoconnect=true&resize=scale&clipboard=true&path=websockify&width=${w}&height=${h}`;
              }
            </script>
          </body>
          </html>
          EOF

      - name: T·∫°o Cloudflare Tunnel & g·ª≠i Webhook
        run: |
          wget -O cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared
          nohup ./cloudflared tunnel --url http://localhost:6080 > cf.txt 2>&1 &
          sleep 15
          LINK=$(grep -o 'https://.*\.trycloudflare.com' cf.txt | head -n 1)

          if [[ -z "$LINK" ]]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y link Cloudflare"
            exit 1
          fi

          FULL_LINK="$LINK/phone.html"
          echo "‚úÖ Link: $FULL_LINK"

          curl -X POST -H "Content-Type: application/json" \
            -d "{\"content\":\"üì± **SNIPAVNCloud ƒë√£ s·∫µn s√†ng!**\\nüîó $FULL_LINK\"}" \
            "$WEBHOOK_URL"

      - name: Kh·ªüi ch·∫°y m√°y ·∫£o QEMU (6 gi·ªù)
        run: |
          echo "‚úÖ Kh·ªüi ƒë·ªông m√°y ·∫£o Android..."
          sudo qemu-system-x86_64 \
            -enable-kvm -m 12G -smp 4 \
            -drive file=android.qcow2,format=qcow2 \
            -cdrom android.iso \
            -drive file=driver.iso,media=cdrom \
            -boot d \
            -net nic -net user \
            -vnc :0 \
            -nographic &
          VM_PID=$!
          for i in {1..21600}; do
            if ! ps -p $VM_PID > /dev/null; then
              echo "‚ö†Ô∏è QEMU VM ƒë√£ d·ª´ng!"
              exit 1
            fi
            sleep 1
          done
